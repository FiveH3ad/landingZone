{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json#",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Azure landing zone accelerator",
            "steps": [
                {
                    "name": "basics",
                    "label": "Deployment settings",
                    "elements": [
                        {
                            "name": "cloudEnvironment",
                            "type": "Microsoft.Common.Section",
                            "label": "Select cloud environment",
                            "elements": [
                                {
                                    "name": "selection",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "label": "Azure cloud environment",
                                    "defaultValue": "[if(contains(steps('basics').resourceScope.location.name, 'china'), 'Azure China Cloud', if(contains(steps('basics').resourceScope.location.name, 'usgov'), 'Azure US Government', if(contains(steps('basics').resourceScope.location.name, 'usdod'), 'Azure US Government', 'Azure Cloud')))]",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": false,
                                    "multiLine": true,
                                    "toolTip": "Select your target Azure cloud environment.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Azure Cloud",
                                                "value": "AzureCloud"
                                            },
                                            {
                                                "label": "Azure China Cloud",
                                                "value": "AzureChinaCloud"
                                            },
                                            {
                                                "label": "Azure US Government",
                                                "value": "AzureUSGovernment"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "warning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "icon": "Warning",
                                        "text": "This value should be automatically set based on the list of available locations. Only change this if you believe the value to be incorrect.",
                                        "uri": "https://docs.microsoft.com/en-us/cli/azure/manage-clouds-azure-cli"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope"
                        },
                        {
                            "name": "getSubscriptions",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "POST",
                                "path": "providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01",
                                "body": {
                                    "query": "ResourceContainers | where type =~ 'microsoft.resources/subscriptions' | where properties.state =~ 'enabled' | project label=tostring(name), description=subscriptionId, value=subscriptionId | order by label asc"
                                }
                            }
                        },
                        {
                            "name": "getLocations",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "locations?api-version=2019-11-01"
                            }
                        },
                        {
                            "name": "getRegulatoryCompliancePolicies",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "POST",
                                "path": "providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01",
                                "body": {
                                    "query": "policyresources | where type == 'microsoft.authorization/policysetdefinitions' | extend metadataCategory=tostring(properties.metadata.category) | extend metadataDeprecated=tostring(properties.metadata.deprecated) | extend displayName=tostring(properties.displayName) | extend description=tostring(properties.description) | where properties.metadata.category =~ 'Regulatory Compliance' | where metadataDeprecated != 'true' |  extend valueOutput=pack('displayName', displayName, 'id', id, 'description', description) | project id, name, displayName, description, metadataCategory, valueOutput | project label=displayName, description, value=valueOutput | order by label asc"
                                }
                            }
                        }
                    ]
                },
                {
                    "name": "core",
                    "label": "Azure core setup",
                    "subLabel": {
                        "preValidation": "Provide a company prefix for the management group structure that will be created.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "ALZ - Core Settings",
                    "elements": [
                        {
                            "name": "info",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "Azure Landing Zones ARM deployment requires access at the tenant root (/) scope. Visit this link to ensure you have the appropriate RBAC permission to complete the deployment",
                                "uri": "https://docs.microsoft.com/azure/role-based-access-control/elevate-access-global-admin",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "mgmtGroup",
                            "type": "Microsoft.Common.TextBlock",
                            "visible": true,
                            "options": {
                                "text": "Azure Landing Zones will create the management group hierarchy under the Tenant Root Group with the prefix provided at this step.",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-group-and-subscription-organization"
                                }
                            }
                        },
                        {
                            "name": "alzMgmtGroupExistingWarning",
                            "type": "Microsoft.Common.InfoBox",
                            "visible": true,
                            "options": {
                                "text": "This deployment will create the ALZ default Management Group hierarchy with Names/IDs that are documented in the FAQ (click on this box to be taken to this page). If you have existing Management Groups that have the same Names/IDs these will be targeted in the ALZ deployment (click on this box to find out how to handle this or to see what will happen)",
                                "style": "Warning",
                                "uri": "https://github.com/Azure/Enterprise-Scale/wiki/FAQ#what-happens-if-i-have-existing-management-groups-that-have-the-same-nameids-as-ones-that-will-be-deployed-in-the-alz-portal-accelerator"
                            }
                        },
                        {
                            "name": "enterpriseScaleCompanyPrefix",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Resource prefix (Root ID)",
                            "toolTip": "Provide a resource prefix (max 10 characters, unique at tenant-scope). This will be used for the Management Group hierarchy and other resources created as part of this deployment.",
                            "defaultValue": "",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-z0-9A-Z-]{1,10}$",
                                "validationMessage": "The prefix must be 1-10 characters."
                            }
                        },
                        {
                            "name": "platformSubscription",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Platform subscription options",
                            "defaultValue": "Dedicated (recommended)",
                            "toolTip": "If 'Dedicated (recommended)' is selected, dedicated Subscriptions will be used for deploying connectivity, identity and management resources. Select Single for testing purposes where all roles will be deployed in a single subscription.",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "Dedicated (recommended)",
                                        "value": "Dedicated"
                                    },
                                    {
                                        "label": "Single",
                                        "value": "Single"
                                    }
                                ]
                            },
                            "visible": true
                        },
                        {
                            "name": "singleSubscription",
                            "type": "Microsoft.Common.Section",
                            "label": "Single platform subscription",
                            "elements": [
                                {
                                    "name": "subWarning",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "icon": "Warning",
                                        "text": "Dedicated subscriptions are recommended for the different platform resource categories to ensure scale, sustainability, and segregation of duties. A single subscription can be used for proof of concepts, or by smaller organizations.",
                                        "uri": "https://docs.microsoft.com/azure/cloud-adoption-framework/ready/enterprise-scale/management-group-and-subscription-organization"
                                    }
                                },
                                {
                                    "name": "singleSubText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Select a single subscription that will be used for all platform resources. This includes resources relating to platform management, security, governance, automation, connectivity, and identity."
                                    }
                                },
                                {
                                    "name": "selector",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Platform subscription",
                                    "defaultValue": "[parse('[]')]",
                                    "toolTip": "",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter subscriptions...",
                                    "multiLine": true,
                                    "visible": true,
                                    "constraints": {
                                        "allowedValues": "[steps('basics').getSubscriptions.data]",
                                        "required": true
                                    }
                                }
                            ],
                            "visible": "[equals(steps('core').platformSubscription, 'Single')]"
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "parameters": {
                "logAnalyticsWorkspaceSkuName": {},
                "logAnalyticsWorkspaceLinkAutomationAccount": {},
                "automationAccountUseManagedIdentity": {},
                "logAnalyticsLinkedServiceAutomationAccountName": {},
                "globalResourceLock": {},
                "logAnalyticsWorkspaceName": {},
                "automationAccountName": {},
                "dataCollectionRuleChangeTrackingName": {},
                "dataCollectionRuleMDFCSQLLock": {},
                "dataCollectionRuleMDFCSQLName": {},
                "dataCollectionRuleVMInsightsLock": {},
                "dataCollectionRuleVMInsightsName": {},
                "userAssignedManagedIdentityName": {},
                "mgDiagnosticsSettingsName": {},
                "disableAlzDefaultPolicies": {},
                "disableSlzDefaultPolicies": {},
                "execludedPolicyAssignments": {},
                "securityContact": {},
                "landingZonesConfidentialOnlineMgSubs": {},
                "platformIdentityMgSubs": {},
                "landingZoneMgChildrenSubs": {},
                "platformMgSubs": {},
                "decommissionedMgSubs": {},
                "platformConnectivityMgSubs": {},
                "landingZonesOnlineMgSubs": {},
                "landingZonesConfidentialCorpMgSubs": {},
                "landingZonesMgSubs": {},
                "intRootMgSubs": {},
                "platformManagementMgSubs": {},
                "landingZonesCorpMgSubs": {},
                "platformMgChildrenSubs": {},
                "sandboxMgSubs": {},
                "enableBastion": {},
                "bastionName": {},
                "bastionNsgName": {},
                "bastionSku": {},
                "enableFirewall": {},
                "firewallName": {},
                "firewallTier": {},
                "enableDdos": {},
                "ddosPlanName": {},
                "enableExpressRoute": {},
                "hubNetworkAddressPrefix": {},
                "hubNetworkName": {},
                "hubRouteTableName": {},
                "enablePrivateDnsZones": {},
                "privateDnsResourceGroupName": {},
                "subnets": {},
                "connectivitySubscriptionId": {}
            },
            "kind": "Tenant",
            "location": "[steps('basics').resourceScope.location.name]"
        }
    }
}
